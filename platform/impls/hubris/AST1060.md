# AST1060 Support for ExHubris

This document describes the AST1060 Aspeed microcontroller support that has been added to ExHubris.

## What was Added

The following AST1060-specific content has been integrated from the [Aspeed Hubris repository](https://github.com/AspeedTech-BMC/hubris/tree/aspeed-devel):

### Chip Configuration (`chips/ast1060/`)

**`chip.toml`** - Peripheral definitions:
- HACE controller: 0x7e6d0000 (hash accelerator)
- UART: 0x7e784000 (serial communication)

**`memory.toml`** - Memory layout:
- Flash: 32KB at 0x00000000
- RAM: 64KB at 0x20000 
- Secure boot header: 32 bytes at 0x400

**`openocd.gdb`** - Debugging configuration:
- GDB remote target setup for OpenOCD
- Hard fault detection
- ARM semihosting support

### Board Configuration

**`boards/ast1060-rot.toml`** - AST1060 Root of Trust board definition:
- probe-rs configuration for the AST1060 chip

### Starter Application (`app/ast1060-starter/`)

**Complete minimal application** for AST1060:
- **`app.toml`**: Hubris application configuration
  - Target: thumbv7em-none-eabihf (ARM Cortex-M4F)
  - Kernel requirements: 20KB flash, 3KB RAM
  - Tasks: jefe (supervisor), idle
- **`Cargo.toml`**: Rust package configuration
- **`src/main.rs`**: Bootstrap code
  - Peripheral initialization
  - JTAG pinmux configuration
  - Optional JTAG halt for debugging
  - Kernel startup

### Workspace Dependencies

Updated **`Cargo.toml`** with AST1060 dependencies:
- `aspeed-ddk`: Aspeed development kit
- `ast1060-pac`: Peripheral Access Crate for AST1060 (using rusty1968/ast1060-pac#exhubris)
- `cortex-m`: ARM Cortex-M support (v0.7)
- `cortex-m-rt`: Runtime for Cortex-M (v0.7.5)

### Build Configuration

The starter application includes:
- **`.cargo/config.toml`**: Automatic target selection (thumbv7em-none-eabihf)
- **Hardware runner**: probe-rs configuration for AST1060
- **Clean build**: No warnings or dependency conflicts

## Key Features

### Hardware Support
- **AST1060 SoC**: Aspeed's Root of Trust microcontroller
- **ARM Cortex-M4F**: 32-bit ARM processor with FPU
- **HACE Controller**: Hardware-accelerated cryptographic engine
- **Memory Protection**: Secure boot and memory isolation

### Cryptographic Capabilities
- **Hash Accelerator**: Hardware SHA support via HACE controller
- **Secure Boot**: Protected boot sequence
- **Root of Trust**: Hardware security foundation

### Development Features
- **JTAG Debug Support**: Hardware debugging capability
- **OpenOCD Integration**: Standard debugging tools
- **Semihosting**: Host communication for development

## Current Status

✅ **Fully Working!** The AST1060 support is now complete and builds successfully.

**Solution**: Using the updated ast1060-pac fork at `https://github.com/rusty1968/ast1060-pac.git` (branch: `exhubris`) which uses cortex-m-rt 0.7.5, compatible with ExHubris.

## Building AST1060 Applications

### Prerequisites

1. **Install AST1060 target**:
   ```bash
   rustup target add thumbv7em-none-eabihf
   ```

2. **Install hubake** (if not already installed):
   ```bash
   cargo install --path tools/hubake
   ```

### Building the Starter Application

```bash
cd app/ast1060-starter
cargo build                    # Uses thumbv7em-none-eabihf target automatically
cargo build --release         # Release build
```

The `.cargo/config.toml` file automatically sets:
- **Target**: `thumbv7em-none-eabihf` (Cortex-M4F)
- **Runner**: `probe-rs run --chip AST1060` (for hardware deployment)

### Application Structure

The AST1060 starter demonstrates:
- **Minimal kernel setup** with supervisor and idle tasks
- **Hardware initialization** including JTAG and peripherals
- **Secure boot compliance** with proper memory layout
- **Debug support** with optional JTAG halt feature

## Integration with OpenPRoT

The AST1060 support enables OpenPRoT to run on Aspeed hardware:

### Cryptographic Services
- **HACE Integration**: Hardware-accelerated hash operations
- **Secure Storage**: Protected memory regions
- **Key Management**: Hardware security features

### Platform Benefits
- **Hardware Security**: Root of Trust capabilities
- **Performance**: Hardware-accelerated crypto operations
- **Isolation**: Task-based security boundaries
- **Reliability**: Microkernel architecture

### Usage in OpenPRoT Context

1. **Hash Operations**: Leverage HACE controller for SHA computations
2. **Key Storage**: Use secure memory regions for cryptographic keys
3. **Secure Boot**: Ensure trusted platform initialization
4. **Task Isolation**: Isolate crypto operations in dedicated tasks

## Next Steps

1. **Test Build**: Verify the AST1060 starter application builds correctly
2. **Hardware Testing**: Deploy to actual AST1060 hardware
3. **OpenPRoT Integration**: Add OpenPRoT-specific tasks and drivers
4. **HACE Driver**: Implement hash accelerator driver for OpenPRoT
5. **Crypto Services**: Add cryptographic service tasks

## File Structure Added

```
exhubris/
├── chips/ast1060/
│   ├── chip.toml          # Peripheral definitions
│   ├── memory.toml        # Memory layout
│   └── openocd.gdb        # Debug configuration
├── boards/
│   └── ast1060-rot.toml   # Board configuration
└── app/ast1060-starter/   # Starter application
    ├── app.toml           # Application config
    ├── Cargo.toml         # Rust package
    ├── README.md          # Documentation
    └── src/main.rs        # Bootstrap code
```

This provides a complete foundation for developing OpenPRoT applications on AST1060 hardware using the ExHubris microkernel.
